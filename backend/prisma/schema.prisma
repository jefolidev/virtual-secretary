generator client {
  provider     = "prisma-client-js"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

model Organization {
  id        String    @id @default(uuid())
  name      String
  cnpj      String    @unique
  slug      String    @unique
  isActive  Boolean   @default(true) @map("is_active")
  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt @map("updated_at")

  ownerId       String
  professionals Professional[]

  addressId String
  address   Address?

  @@map("organizations")
}

model User {
  id             String    @id @default(uuid())
  name           String
  email          String    @unique
  cpf            String    @unique
  whatsappNumber String    @unique @map("whatsapp_number")
  role           Role
  password       String
  gender         Genders
  birthDate      DateTime  @map("birth_date")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime? @updatedAt @map("updated_at")

  threadId String? @unique @map("thread_id")

  addressId String?  @unique @map("address_id")
  address   Address? @relation(fields: [addressId], references: [id])

  professional   Professional? @relation(fields: [professionalId], references: [id])
  professionalId String?       @unique @map("professional_id")

  client   Client? @relation(fields: [clientId], references: [id])
  clientId String? @unique @map("client_id")

  notifications Notification[]

  messages     Message[]
  flowSessions FlowSession[]
  sessions     Session[]

  @@map("users")
}

model Appointment {
  id                     String     @id @default(uuid())
  clientId               String     @map("client_id")
  professionalId         String     @map("professional_id")
  startDateTime          DateTime   @map("start_date_time")
  endDateTime            DateTime   @map("end_date_time")
  modality               Modalities
  status                 Status     @default(SCHEDULED)
  syncWithGoogleCalendar Boolean    @default(false) @map("sync_with_google_calendar")
  googleMeetLink         String?    @map("google_meet_link")
  rescheduleDateTime     Json?      @map("reschedule_date_time")
  startedAt              DateTime?  @map("started_at")
  totalElapsedMs         BigInt?    @default(0) @map("total_elapsed_ms")

  agreedPrice          Decimal       @map("agreed_price") @db.Decimal(10, 2)
  paymentStatus        PaymentStatus @default(PENDING) @map("payment_status")
  paymentExpiresAt     DateTime?     @map("payment_expires_at")
  currentTransactionId String?       @map("current_transaction_id")

  client       Client       @relation(fields: [clientId], references: [id])
  professional Professional @relation(fields: [professionalId], references: [id])

  createdAt            DateTime             @default(now())
  updatedAt            DateTime?            @updatedAt @map("updated_at")
  transactions         Transaction[]
  appointmentHistories AppointmentHistory[]
  calendarEvent        CalendarEvent?

  @@map("appointments")
}

model AppointmentHistory {
  id                    String            @id @default(uuid())
  appointmentId         String            @map("appointment_id")
  action                AppointmentAction @map("changed_field")
  previousStartDateTime String?           @map("previous_start_date_time")
  newStartDateTime      String?           @map("new_start_date_time")

  changedAt DateTime @default(now()) @map("changed_at")

  appointment Appointment @relation(fields: [appointmentId], references: [id])

  @@map("appointment_history")
}

model Professional {
  id                     String        @id @default(uuid())
  mercadoPagoAccountId   String?       @unique @map("mercado_pago_account_id")
  notificationSettingsId String?       @unique @map("notification_settings_id")
  organizationId         String?       @map("organization_id")
  sessionPrice           Decimal       @map("session_price")
  appointments           Appointment[]

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")

  notificationSettings NotificationSettings? @relation(fields: [notificationSettingsId], references: [id])

  cancellationPolicyId String?             @unique @map("cancellation_policy_id")
  cancellationPolicy   CancellationPolicy?

  organization Organization? @relation(fields: [organizationId], references: [id])

  user User?

  scheduleConfigurationId String?                @unique @map("schedule_configuration_id")
  scheduleConfiguration   ScheduleConfiguration?

  googleCalendarTokens GoogleCalendarToken?

  @@map("professionals")
}

model GoogleCalendarToken {
  id                 String  @id @default(uuid())
  professionalId     String  @unique @map("professional_id")
  accessToken        String  @map("access_token")
  refreshToken       String  @map("refresh_token")
  tokenType          String  @default("Bearer") @map("token_type")
  expiryDate         BigInt? @map("expiry_date")
  scope              String?
  googleAccountEmail String? @map("google_account_email")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")

  professional Professional @relation(fields: [professionalId], references: [id], onDelete: Cascade)

  @@map("google_calendar_tokens")
}

model CalendarEvent {
  id              String  @id @default(uuid())
  appointmentId   String  @unique @map("appointment_id")
  professionalId  String  @map("professional_id")
  googleEventId   String  @map("google_event_id")
  googleEventLink String  @map("google_event_link")
  googleMeetLink  String? @map("google_meet_link")
  summary       String
  description   String?
  startDateTime DateTime @map("start_date_time")
  endDateTime   DateTime @map("end_date_time")
  syncStatus    String   @default("SYNCED") @map("sync_status") // SYNCED, PENDING, ERROR
  lastSyncedAt  DateTime @default(now()) @map("last_synced_at")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")

  appointment Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@map("calendar_events")
}

model NotificationSettings {
  id                    String             @id @default(uuid())
  enabledTypes          NotificationType[] @default([CONFIRMATION, CANCELLATION]) @map("enabled_types")
  reminderBeforeMinutes Int                @default(10) @map("reminder_before_minutes")
  dailySummaryTime      String             @default("12:00") @map("daily_summary_time")

  professional Professional?

  @@map("notification_settings")
}

model CancellationPolicy {
  id                           String    @id @default(uuid())
  minHoursBeforeCancellation   Int       @default(6) @map("min_hours_before_cancellation")
  minDaysBeforeNextAppointment Int       @default(1) @map("min_days_before_next_appointment")
  cancellationFeePercentage    Decimal   @default(0.6) @map("cancellation_fee_percentage")
  allowReschedule              Boolean   @default(false) @map("allow_reschedule")
  description                  String
  createdAt                    DateTime  @default(now()) @map("created_at")
  updatedAt                    DateTime? @map("updated_at")

  professionalId String?       @unique @map("professional_id")
  professional   Professional? @relation(fields: [professionalId], references: [id])

  @@map("cancellation_policy")
}

model ScheduleConfiguration {
  id                     String     @id @default(uuid())
  workingDays            Int[]      @map("working_days")
  workStartHour          String     @map("work_start_hour")
  workEndHour            String     @map("work_end_hour")
  sessionDurationMinutes Int        @default(60) @map("session_duration_minutes")
  bufferIntervalMinutes  Int        @default(10) @map("buffer_interval_minutes")
  holidays               DateTime[]
  enableGoogleMeet       Boolean    @default(false) @map("enable_google_meet")
  createdAt              DateTime   @default(now()) @map("created_at")
  updatedAt              DateTime?  @map("updated_at")

  professional   Professional @relation(fields: [professionalId], references: [id])
  professionalId String       @unique @map("professional_id")

  @@map("schedule_configuration")
}

model Client {
  id               String             @id @default(uuid())
  periodPreference PeriodPreference[] @map("period_preference")
  extraPreference  String?            @map("extra_preference")
  createdAt        DateTime           @default(now()) @map("created_at")
  updatedAt        DateTime?          @updatedAt @map("updated_at")

  appointments Appointment[]

  users User?

  @@map("clients")
}

model Address {
  id           String  @id @default(uuid())
  addressLine1 String  @map("address_line_1")
  addressLine2 String? @map("address_line_2")
  neighborhood String
  city         String
  state        String
  postalCode   String  @map("postal_code")
  country      String

  organizationId String?       @unique @map("organization_id")
  organization   Organization? @relation(fields: [organizationId], references: [id])

  user User?

  @@map("addresses")
}

model Transaction {
  id            String @id @default(uuid())
  appointmentId String @unique @map("appointment_id")

  externalReference String @map("external_reference")

  pixCopyPaste String? @map("pix_copy_paste")
  pixQrCodeURL String? @map("pix_qr_code_url")

  amount Decimal        @db.Decimal(10, 2)
  status PaymentStatus  @default(PROCESSING)
  method PaymentMethods

  appointment Appointment? @relation(fields: [appointmentId], references: [id])

  createdAt DateTime  @default(now()) @map("created_at")
  paidAt    DateTime? @map("paid_at")

  @@map("transactions")
}

model Notification {
  id          String           @id @default(uuid())
  recipientId String           @map("recipient_id")
  type        NotificationType
  title       String
  content     String

  readAt DateTime? @map("read_at")
  sentAt DateTime  @map("sent_at")

  recipient User @relation(fields: [recipientId], references: [id])

  @@map("notifications")
}

model Message {
  id             String     @id @default(uuid())
  sender         SenderEnum @map("sender")
  text           String
  intentDetected String?    @map("intent_detected")
  userId         String     @map("user_id")
  contact        User       @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")

  @@map("messages")
}

model Session {
  id          String                    @id @default(uuid())
  userId      String?                   @map("user_id")
  currentFlow String?                   @map("current_flow")
  currentStep String?                   @map("current_step")
  contextData Json?                     @map("context_data")
  status      ConversationSessionStatus @default(ACTIVE)

  startedAt         DateTime? @default(now()) @map("started_at")
  endedAt           DateTime? @map("ended_at")
  lastInteractionAt DateTime? @map("last_interaction_at")

  user         User?         @relation(fields: [userId], references: [id])
  createdAt    DateTime      @default(now()) @map("created_at")
  intentLogs   IntentLog[]
  flowSessions FlowSession[]

  @@map("sessions")
}

model FlowSession {
  id          String     @id @default(uuid())
  userId      String     @map("user_id")
  sessionId   String     @map("session_id")
  currentFlow String?    @map("current_flow")
  currentStep String?    @map("current_step")
  context     String
  status      FlowStatus

  user      User      @relation(fields: [userId], references: [id])
  session   Session   @relation(fields: [sessionId], references: [id])
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")

  @@map("flow_sessions")
}

model IntentLog {
  id            String @id @default(uuid())
  sessionId     String @map("session_id")
  clientMessage String @map("client_message")
  extractedData Json   @map("extracted_data")

  session   Session  @relation(fields: [sessionId], references: [id])
  createdAt DateTime @default(now()) @map("created_at")

  @@map("intent_log")
}

enum ConversationSessionStatus {
  ACTIVE
  FINISHED
  EXPIRED
}

enum SenderEnum {
  USER
  BOT
}

enum FlowStatus {
  ACTIVE
  FINISHED
  CANCELLED
  EXPIRED
}

enum AppointmentAction {
  CREATE
  RESCHEDULE
  CANCEL
}

enum Role {
  CLIENT
  PROFESSIONAL
}

enum PeriodPreference {
  MORNING
  AFTERNOON
  EVENING
}

enum Modalities {
  IN_PERSON
  ONLINE
}

enum Status {
  SCHEDULED
  CONFIRMED
  CANCELLED
  RESCHEDULED
  NO_SHOW
  IN_PROGRESS
  COMPLETED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  REFUNDED
}

enum PaymentMethods {
  CARD
  PIX
}

enum NotificationChannel {
  EMAIL
  WHATSAPP
}

enum NotificationType {
  NEW_APPOINTMENT
  CANCELLATION
  CONFIRMATION
  DAILY_SUMMARY
  CONFIRMED_LIST
  PAYMENT_STATUS
  WELCOME
  REMOVAL
  FIRST_REMINDER
  FINAL_REMINDER
  USER_CONFIRMATION
}

enum WeekDays {
  SUNDAY
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
}

enum Genders {
  MALE
  FEMALE
}
