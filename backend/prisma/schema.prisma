generator client {
  provider     = "prisma-client"
  moduleFormat = "cjs"
  output       = "./generated/"
}

datasource db {
  provider = "postgresql"
}

model Organization {
  id        String    @id @default(uuid())
  name      String
  cnpj      String    @unique
  slug      String    @unique
  isActive  Boolean   @default(true) @map("is_active")
  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt @map("updated_at")

  ownerId       String
  professionals Professional[]

  address Address?

  @@map("organizations")
}

model User {
  id        String    @id @default(uuid())
  name      String
  email     String    @unique
  cpf       String    @unique
  phone     String    @unique
  role      Role
  password  String
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")

  address Address?

  professional   Professional? @relation(fields: [professionalId], references: [id])
  professionalId String?       @unique @map("professional_id")

  client   Client? @relation(fields: [clientId], references: [id])
  clientId String? @unique @map("client_id")

  @@map("users")
}

model Appointment {
  id                 String     @id @default(uuid())
  clientId           String     @map("client_id")
  professionalId     String     @map("professional_id")
  startDateTime      DateTime   @map("start_date_time")
  endDateTime        DateTime   @map("end_date_time")
  modality           Modalities
  status             Status     @default(PENDING_PAYMENT)
  agreedPrice        Decimal    @map("agreed_price") @db.Decimal(10, 2)
  googleMeetLink     String?    @map("google_meet_link")
  rescheduleDateTime Json?      @map("reschedule_date_time")
  paymentExpiresAt   DateTime?  @map("payment_expires_at")

  client       Client       @relation(fields: [clientId], references: [id])
  professional Professional @relation(fields: [professionalId], references: [id])

  createdAt    DateTime      @default(now())
  updatedAt    DateTime?     @updatedAt @map("updated_at")
  transactions Transaction[]

  @@map("appointments")
}

model Professional {
  id             String        @id @default(uuid())
  organizationId String?       @map("organization_id")
  sessionPrice   Decimal       @map("session_price")
  appointments   Appointment[]

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")

  notificationSettings   NotificationSettings? @relation(fields: [notificationSettingsId], references: [id])
  notificationSettingsId String?               @unique @map("notification_settings_id")

  cancellationPollicy   CancellationPolicy? @relation(fields: [cancellationPollicyId], references: [id])
  cancellationPollicyId String?             @unique @map("cancellation_pollicy_id")

  scheduleConfiguration   ScheduleConfiguration? @relation(fields: [scheduleConfigurationId], references: [id])
  scheduleConfigurationId String?                @unique @map("schedule_configuration_id")

  organization Organization? @relation(fields: [organizationId], references: [id])
  users        User?

  @@map("professionals")
}

model NotificationSettings {
  id                    String                @id @default(uuid())
  channels              NotificationChannel[] @default([EMAIL, WHATSAPP])
  enabledTypes          NotificationType[]    @default([CONFIRMATION, CANCELLATION]) @map("enabled_types")
  reminderBeforeMinutes Int                   @default(10) @map("reminder_before_minutes")
  dailySummaryTime      String                @default("12:00") @map("daily_summary_time")

  professional Professional?

  @@map("notification_settings")
}

model CancellationPolicy {
  id                           String  @id @default(uuid())
  minHoursBeforeCancellation   Int     @default(6) @map("min_hours_before_cancellation")
  minDaysBeforeNextAppointment Int     @default(1) @map("min_days_before_next_appointment")
  cancellationFeePercentage    Decimal @default(0.6) @map("cancellation_fee_percentage")
  allowReschedule              Boolean @default(false) @map("allow_reschedule")
  description                  String?

  professional Professional?

  @@map("cancellation_policy")
}

model ScheduleConfiguration {
  id                     String     @id @default(uuid())
  // workingDays TODO - Corrigir e ver como implementar o List
  workingHours           Json?      @map("working_hours")
  sessionDurationMinutes Int        @default(60) @map("session_duration_minutes")
  bufferIntervalMinutes  Int        @default(10) @map("buffer_interval_minutes")
  holidays               DateTime[]
  enableGoogleMeet       Boolean    @default(false) @map("enable_google_meet")

  professional Professional?

  @@map("schedule_configuration")
}

model Client {
  id               String             @id @default(uuid())
  periodPreference PeriodPreference[] @map("period_preference")
  extraPreference  String?            @map("extra_preference")
  createdAt        DateTime           @default(now()) @map("created_at")
  updatedAt        DateTime?          @updatedAt @map("updated_at")
  appointments     Appointment[]

  users User?

  @@map("clients")
}

model Address {
  id           String  @id @default(uuid())
  addressLine1 String  @map("address_line_1")
  addressLine2 String? @map("address_line_2")
  neighborhood String
  city         String
  state        String
  postalCode   String  @map("postal_code")
  country      String

  organizationId String?       @unique @map("organization_id")
  organization   Organization? @relation(fields: [organizationId], references: [id])

  userId String? @unique @map("user_id")
  user   User?   @relation(fields: [userId], references: [id])

  @@map("addresses")
}

model Transaction {
  id                   String         @id @default(uuid())
  appointmentId        String         @unique @map("appointment_id")
  stripePaymentItentId String         @map("stripe_payment_itent_id")
  amount               Decimal
  status               PaymentStatus  @default(PROCESSING)
  method               PaymentMethods

  appointment Appointment? @relation(fields: [appointmentId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")

  @@map("transactions")
}

enum Role {
  CLIENT
  PROFESSIONAL
}

enum PeriodPreference {
  MORNING
  AFTERNOON
  EVENING
}

enum Modalities {
  IN_PERSON
  ONLINE
}

enum Status {
  SCHEDULED
  CONFIRMED
  CANCELLED
  RESCHEDULED
  PENDING_PAYMENT
  NO_SHOW
  IN_PROGRESS
  COMPLETED
}

enum PaymentStatus {
  PROCESSING
  SUCCEEDED
  FAILED
  REFUNDED
}

enum PaymentMethods {
  CARD
  PIX
}

enum NotificationChannel {
  EMAIL
  WHATSAPP
}

enum NotificationType {
  NEW_APPOINTMENT
  CANCELLATION
  CONFIRMATION
  DAILY_SUMMARY
  CONFIRMED_LIST
  PAYMENT_STATUS
}
